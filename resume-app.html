<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Resume Builder — KodNest</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Serif+4:opsz,wght@8..60,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="tokens.css">
  <link rel="stylesheet" href="base.css">
  <style>
    .kn-resume-nav { display: flex; align-items: center; gap: var(--kn-space-3); list-style: none; margin: 0; padding: 0; }
    .kn-resume-nav__link { font-weight: 500; color: var(--kn-text); text-decoration: none; padding-bottom: 2px; border-bottom: 2px solid transparent; transition: var(--kn-transition); }
    .kn-resume-nav__link:hover { color: var(--kn-accent); }
    .kn-resume-nav__link.is-active { color: var(--kn-accent); border-bottom-color: var(--kn-accent); }
    .kn-landing { text-align: center; max-width: 560px; margin: 0 auto; padding: var(--kn-space-5) var(--kn-space-4); width: 100%; }
    .kn-main.kn-main--home { display: flex; align-items: center; justify-content: center; min-height: 60vh; }
    .kn-landing__headline { font-family: var(--kn-font-serif); font-weight: 600; font-size: var(--kn-heading-size-xl); letter-spacing: 0.02em; margin: 0 0 var(--kn-space-2); line-height: 1.2; }
    .kn-landing__sub { font-size: var(--kn-text-size-lg); color: var(--kn-text-muted); margin: 0 0 var(--kn-space-4); }
    .kn-builder-row { display: flex; gap: var(--kn-space-4); align-items: flex-start; }
    .kn-builder-form { flex: 1; min-width: 0; }
    .kn-builder-panel { width: 400px; min-width: 320px; position: sticky; top: var(--kn-space-3); }
    .kn-form-section { margin-bottom: var(--kn-space-4); }
    .kn-form-section__title { font-family: var(--kn-font-serif); font-weight: 600; font-size: var(--kn-heading-size); margin: 0 0 var(--kn-space-2); }
    .kn-form-section .kn-field { margin-bottom: var(--kn-space-2); }
    .kn-entry-list { list-style: none; margin: 0; padding: 0; }
    .kn-entry-item { padding: var(--kn-space-2); border: 1px solid var(--kn-border); border-radius: var(--kn-radius); margin-bottom: var(--kn-space-2); background: var(--kn-background); }
    .kn-entry-item__row { display: flex; gap: var(--kn-space-2); margin-bottom: var(--kn-space-1); }
    .kn-entry-item__row:last-child { margin-bottom: 0; }
    .kn-entry-item .kn-input { flex: 1; min-width: 0; }
    .kn-entry-item .kn-textarea { min-height: 60px; }
    .kn-entry-remove { padding: var(--kn-space-1) var(--kn-space-2); font-size: var(--kn-text-size-sm); }
    .kn-add-entry { margin-top: var(--kn-space-2); }
    .kn-preview-paper { padding: var(--kn-space-4); min-height: 500px; background: #fff; border: 1px solid var(--kn-border); }
    .kn-preview-minimal { color: #111; background: #fff; }
    .kn-preview-minimal .preview-name { font-family: var(--kn-font-serif); font-size: 24px; font-weight: 600; margin: 0 0 var(--kn-space-1); }
    .kn-preview-minimal .preview-contact { font-size: 12px; color: #444; margin: 0 0 var(--kn-space-3); }
    .kn-preview-minimal .preview-section { margin-bottom: var(--kn-space-3); }
    .kn-preview-minimal .preview-section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid #111; padding-bottom: 4px; margin: 0 0 var(--kn-space-1); }
    .kn-preview-minimal .preview-item-title { font-weight: 600; font-size: 14px; margin: 0 0 2px; }
    .kn-preview-minimal .preview-item { margin-bottom: var(--kn-space-2); }
    .kn-preview-minimal .preview-item:last-child { margin-bottom: 0; }
    .kn-preview-minimal .preview-item-meta { font-size: 12px; color: #444; margin: 0 0 4px; }
    .kn-preview-minimal .preview-item-desc { font-size: 13px; line-height: 1.5; margin: 0; }
    .kn-preview-minimal .preview-placeholder { color: #999; font-style: italic; }
    .kn-ats-score { margin-bottom: var(--kn-space-3); }
    .kn-ats-score__label { font-size: var(--kn-text-size-sm); font-weight: 500; color: var(--kn-text-muted); margin-bottom: var(--kn-space-1); }
    .kn-ats-score__meter { height: 8px; background: var(--kn-border); border-radius: 4px; overflow: hidden; }
    .kn-ats-score__fill { height: 100%; border-radius: 4px; transition: width var(--kn-transition); }
    .kn-ats-score__value { font-size: var(--kn-text-size-sm); font-weight: 600; margin-top: var(--kn-space-1); color: var(--kn-text); }
    .kn-ats-circular { width: 120px; height: 120px; margin: 0 auto var(--kn-space-2); position: relative; }
    .kn-ats-circular svg { transform: rotate(-90deg); }
    .kn-ats-circular__bg { fill: none; stroke: var(--kn-border); stroke-width: 8; }
    .kn-ats-circular__fill { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset var(--kn-transition), stroke 0.2s; }
    .kn-ats-circular__value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: 600; }
    .kn-ats-circular__label { text-align: center; font-size: var(--kn-text-size-sm); font-weight: 500; margin-top: var(--kn-space-1); }
    .kn-ats-suggestions { margin-top: var(--kn-space-2); padding-top: var(--kn-space-2); border-top: 1px solid var(--kn-border); }
    .kn-ats-suggestions__title { font-size: var(--kn-text-size-sm); font-weight: 500; color: var(--kn-text-muted); margin-bottom: var(--kn-space-1); }
    .kn-ats-suggestions ul { margin: 0; padding-left: var(--kn-space-2); font-size: var(--kn-text-size-sm); color: var(--kn-text); line-height: 1.6; }
    .kn-template-tabs { display: flex; gap: var(--kn-space-1); margin-bottom: var(--kn-space-2); }
    .kn-template-tab { padding: var(--kn-space-1) var(--kn-space-2); font-size: var(--kn-text-size-sm); font-weight: 500; border: 1px solid var(--kn-border); border-radius: var(--kn-radius); background: transparent; color: var(--kn-text); cursor: pointer; transition: var(--kn-transition); }
    .kn-template-tab:hover { border-color: var(--kn-text-muted); }
    .kn-template-tab.is-active { border-color: var(--kn-accent); background: rgba(139,0,0,0.06); color: var(--kn-accent); }
    .kn-template-picker { display: flex; gap: var(--kn-space-2); margin-bottom: var(--kn-space-3); flex-wrap: wrap; }
    .kn-template-thumb { width: 120px; height: 150px; border: 2px solid var(--kn-border); border-radius: var(--kn-radius); cursor: pointer; overflow: hidden; background: #fff; transition: var(--kn-transition); position: relative; }
    .kn-template-thumb:hover { border-color: var(--kn-text-muted); }
    .kn-template-thumb.is-active { border-color: #2563eb; box-shadow: 0 0 0 1px #2563eb; }
    .kn-template-thumb.is-active::after { content: '✓'; position: absolute; top: 6px; right: 6px; width: 18px; height: 18px; line-height: 18px; text-align: center; background: #2563eb; color: #fff; font-size: 12px; font-weight: 600; border-radius: 50%; }
    .kn-thumb-classic { padding: 8px; }
    .kn-thumb-classic .kn-thumb-line { height: 3px; background: rgba(17,17,17,0.2); margin: 6px 0; border-radius: 1px; }
    .kn-thumb-classic .kn-thumb-block { height: 8px; background: rgba(17,17,17,0.1); border-radius: 2px; margin: 4px 0; }
    .kn-thumb-modern { display: flex; }
    .kn-thumb-modern .kn-thumb-sidebar { width: 36px; background: hsl(168, 60%, 40%); }
    .kn-thumb-modern .kn-thumb-main { flex: 1; padding: 8px; }
    .kn-thumb-modern .kn-thumb-block { height: 6px; background: rgba(17,17,17,0.1); border-radius: 2px; margin: 4px 0; }
    .kn-thumb-minimal { padding: 12px; }
    .kn-thumb-minimal .kn-thumb-block { height: 5px; background: rgba(17,17,17,0.08); border-radius: 2px; margin: 8px 0; }
    .kn-color-picker { display: flex; gap: var(--kn-space-2); margin-bottom: var(--kn-space-3); align-items: center; flex-wrap: wrap; }
    .kn-color-picker__label { font-size: var(--kn-text-size-sm); color: var(--kn-text-muted); }
    .kn-color-swatch { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: var(--kn-transition); }
    .kn-color-swatch:hover { transform: scale(1.1); }
    .kn-color-swatch.is-active { border-color: #111; box-shadow: 0 0 0 1px #fff, 0 0 0 3px #111; }
    .kn-toast { position: fixed; bottom: var(--kn-space-3); left: 50%; transform: translateX(-50%); padding: var(--kn-space-2) var(--kn-space-3); background: #111; color: #fff; font-size: var(--kn-text-size-sm); border-radius: var(--kn-radius); z-index: 9999; animation: kn-toast-in 0.2s ease-out; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    @keyframes kn-toast-in { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .kn-bullet-guidance { margin-top: var(--kn-space-1); font-size: 12px; color: var(--kn-text-muted); line-height: 1.5; }
    .kn-bullet-guidance__item { margin-top: 2px; }
    .kn-bullet-guidance__tip { color: var(--kn-warning); }
    .kn-preview-paper { --kn-resume-accent: var(--kn-accent); }
    .kn-preview-paper.tpl-classic .preview-name { font-size: 24px; font-family: var(--kn-font-serif); color: var(--kn-resume-accent); }
    .kn-preview-paper.tpl-classic .preview-section { border-bottom: 1px solid rgba(17,17,17,0.15); padding-bottom: var(--kn-space-2); }
    .kn-preview-paper.tpl-classic .preview-section:last-child { border-bottom: none; }
    .kn-preview-paper.tpl-classic .preview-section-title { border-bottom: 1px solid var(--kn-resume-accent); }
    .kn-preview-paper.tpl-modern { display: flex; }
    .kn-preview-paper.tpl-modern .kn-preview-sidebar { width: 140px; min-width: 140px; padding: var(--kn-space-3); background: var(--kn-resume-accent); color: #fff; }
    .kn-preview-paper.tpl-modern .kn-preview-sidebar .preview-section-title { border: none; color: rgba(255,255,255,0.9); }
    .kn-preview-paper.tpl-modern .kn-preview-sidebar .preview-item-desc { color: rgba(255,255,255,0.9); }
    .kn-preview-paper.tpl-modern .kn-preview-sidebar .kn-preview-skill-pill { border-color: rgba(255,255,255,0.5); color: #fff; }
    .kn-preview-paper.tpl-modern .kn-preview-main { flex: 1; padding: var(--kn-space-3); }
    .kn-preview-paper.tpl-modern .preview-name { font-size: 22px; font-family: var(--kn-font-sans); font-weight: 600; color: var(--kn-resume-accent); }
    .kn-preview-paper.tpl-modern .preview-section-title { font-size: 12px; letter-spacing: 0.08em; color: var(--kn-resume-accent); }
    .kn-preview-paper.tpl-minimal .preview-name { font-size: 20px; color: var(--kn-resume-accent); }
    .kn-preview-paper.tpl-minimal .preview-section { margin-bottom: var(--kn-space-2); }
    .kn-preview-paper.tpl-minimal .preview-section-title { font-size: 10px; padding-bottom: 2px; border: none; color: var(--kn-resume-accent); }
    .kn-improvements { margin-top: var(--kn-space-2); padding-top: var(--kn-space-2); border-top: 1px solid var(--kn-border); }
    .kn-improvements__title { font-size: var(--kn-text-size-sm); font-weight: 500; color: var(--kn-text-muted); margin-bottom: var(--kn-space-1); }
    .kn-improvements ul { margin: 0; padding-left: var(--kn-space-2); font-size: var(--kn-text-size-sm); color: var(--kn-text); line-height: 1.6; }
    .kn-accordion { border: 1px solid var(--kn-border); border-radius: var(--kn-radius); margin-bottom: var(--kn-space-2); overflow: hidden; }
    .kn-accordion__header { display: flex; align-items: center; justify-content: space-between; padding: var(--kn-space-2); background: var(--kn-background); cursor: pointer; font-weight: 500; }
    .kn-accordion__header:hover { background: rgba(17,17,17,0.03); }
    .kn-accordion__body { padding: var(--kn-space-2); border-top: 1px solid var(--kn-border); }
    .kn-accordion.is-closed .kn-accordion__body { display: none; }
    .kn-tag-input-wrap { display: flex; flex-wrap: wrap; gap: var(--kn-space-1); align-items: center; padding: var(--kn-space-1); border: 1px solid var(--kn-border); border-radius: var(--kn-radius); min-height: 40px; }
    .kn-tag-input-wrap:focus-within { border-color: var(--kn-accent); }
    .kn-tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 4px var(--kn-space-1); font-size: var(--kn-text-size-sm); background: rgba(17,17,17,0.06); border: 1px solid var(--kn-border); border-radius: 4px; }
    .kn-tag-chip__remove { padding: 0 4px; cursor: pointer; color: var(--kn-text-muted); font-size: 14px; line-height: 1; }
    .kn-tag-chip__remove:hover { color: var(--kn-accent); }
    .kn-tag-input { flex: 1; min-width: 80px; border: none; padding: 4px 0; font-size: var(--kn-text-size-sm); background: transparent; }
    .kn-tag-input:focus { outline: none; }
    .kn-desc-counter { font-size: 12px; color: var(--kn-text-muted); margin-top: 2px; }
    .kn-desc-counter.is-over { color: var(--kn-warning); }
    .kn-preview-skill-group { margin-bottom: var(--kn-space-1); }
    .kn-preview-skill-pills { display: flex; flex-wrap: wrap; gap: 6px; }
    .kn-preview-skill-pill { display: inline-block; padding: 2px 8px; font-size: 12px; border: 1px solid var(--kn-border); border-radius: 4px; }
    .kn-preview-project-card { padding: var(--kn-space-2); border: 1px solid var(--kn-border); border-radius: var(--kn-radius); margin-bottom: var(--kn-space-2); }
    .kn-preview-project-card:last-child { margin-bottom: 0; }
    .kn-preview-project-links { display: flex; gap: var(--kn-space-2); margin-top: var(--kn-space-1); font-size: 12px; }
    .kn-preview-project-links a { color: #111; text-decoration: none; }
    .kn-preview-project-links a:hover { text-decoration: underline; }
    .kn-export-actions { display: flex; flex-wrap: wrap; gap: var(--kn-space-2); margin-bottom: var(--kn-space-4); }
    .kn-export-warning { padding: var(--kn-space-2); margin-bottom: var(--kn-space-3); font-size: var(--kn-text-size-sm); color: var(--kn-warning); border: 1px solid rgba(139,115,85,0.3); border-radius: var(--kn-radius); background: rgba(139,115,85,0.06); }
    .kn-preview-minimal .preview-item { break-inside: avoid; }
    .kn-preview-minimal .preview-section { overflow: hidden; }
    .kn-preview-minimal .preview-item-desc { overflow-wrap: break-word; }
    .kn-proof-step { display: flex; align-items: center; justify-content: space-between; padding: var(--kn-space-2); border-bottom: 1px solid var(--kn-border); }
    .kn-proof-step:last-child { border-bottom: none; }
    .kn-proof-step__status { font-size: var(--kn-text-size-sm); font-weight: 500; }
    .kn-proof-step__status.done { color: var(--kn-success); }
    .kn-proof-step__status.pending { color: var(--kn-text-muted); }
    .kn-proof-status-badge { display: inline-block; padding: 4px var(--kn-space-2); font-size: var(--kn-text-size-sm); font-weight: 600; border-radius: var(--kn-radius); }
    .kn-proof-status-badge.shipped { background: rgba(22,163,74,0.12); color: var(--kn-success); }
    .kn-proof-status-badge.in-progress { background: rgba(17,17,17,0.06); color: var(--kn-text-muted); }
    .kn-proof-input-error { font-size: 12px; color: #dc2626; margin-top: 2px; }
    .kn-proof-shipped-msg { padding: var(--kn-space-4); text-align: center; font-family: var(--kn-font-serif); font-size: var(--kn-heading-size); font-weight: 600; color: var(--kn-text); }
    @media (max-width: 900px) { .kn-builder-row { flex-direction: column; } .kn-builder-panel { width: 100%; position: static; } }
    @media print {
      header, .kn-export-actions, .kn-template-picker, .kn-color-picker, .kn-export-warning, .kn-ats-preview-block, .kn-card > h1, .kn-card > p, .kn-toast { display: none !important; }
      body, .kn-page, .kn-main { background: #fff !important; }
      .kn-print-resume { padding: 0 !important; margin: 0 !important; border: none !important; background: #fff !important; box-shadow: none !important; }
      .kn-print-resume * { color: #111 !important; background: transparent !important; }
      .kn-print-resume a { color: #111 !important; text-decoration: underline !important; }
      .kn-preview-paper { border: none !important; box-shadow: none !important; min-height: auto !important; }
      .kn-preview-minimal .preview-section { break-inside: avoid; }
      .kn-preview-minimal .preview-item { break-inside: avoid; page-break-inside: avoid; }
      .kn-card { border: none !important; box-shadow: none !important; }
      @page { margin: 20mm; }
    }
  </style>
</head>
<body>
  <div class="kn-page">
    <header class="kn-top-bar">
      <a href="#/" class="kn-top-bar__project" style="text-decoration:none;color:inherit;">AI Resume Builder</a>
      <nav>
        <ul class="kn-resume-nav">
          <li><a href="#/" class="kn-resume-nav__link" data-route="">Home</a></li>
          <li><a href="#/builder" class="kn-resume-nav__link" data-route="builder">Builder</a></li>
          <li><a href="#/preview" class="kn-resume-nav__link" data-route="preview">Preview</a></li>
          <li><a href="#/proof" class="kn-resume-nav__link" data-route="proof">Proof</a></li>
        </ul>
      </nav>
    </header>

    <main class="kn-main" id="resume-main"></main>
  </div>

  <script>
    (function () {
      var DATA_KEY = 'resumeBuilderData';
      var TEMPLATE_KEY = 'resumeBuilderTemplate';
      var COLOR_KEY = 'resumeBuilderColor';
      var PROOF_SUBMISSION_KEY = 'rb_final_submission';
      var PROOF_CHECKLIST_KEY = 'rb_proof_checklist';

      var COLOR_THEMES = {
        teal: 'hsl(168, 60%, 40%)',
        navy: 'hsl(220, 60%, 35%)',
        burgundy: 'hsl(345, 60%, 35%)',
        forest: 'hsl(150, 50%, 30%)',
        charcoal: 'hsl(0, 0%, 25%)'
      };

      var ACTION_VERBS = ['built', 'developed', 'designed', 'implemented', 'led', 'improved', 'created', 'optimized', 'automated'];

      function getTemplate() {
        var t = (localStorage.getItem(TEMPLATE_KEY) || 'classic').toLowerCase();
        return ['classic', 'modern', 'minimal'].indexOf(t) >= 0 ? t : 'classic';
      }

      function setTemplate(t) {
        if (['classic', 'modern', 'minimal'].indexOf(t) >= 0) localStorage.setItem(TEMPLATE_KEY, t);
      }

      function getColor() {
        var c = (localStorage.getItem(COLOR_KEY) || 'teal').toLowerCase();
        return COLOR_THEMES[c] ? c : 'teal';
      }

      function setColor(c) {
        if (COLOR_THEMES[c]) localStorage.setItem(COLOR_KEY, c);
      }

      function getAccentHsl() {
        return COLOR_THEMES[getColor()] || COLOR_THEMES.teal;
      }

      function getRoute() {
        var hash = (window.location.hash || '#/').slice(1);
        return hash.replace(/^\/+|\/+$/g, '') || '';
      }

      function migrateData(raw) {
        if (!raw) return defaultData();
        var d = JSON.parse(JSON.stringify(raw));
        if (typeof d.skills === 'string') {
          var parts = (d.skills || '').split(',').map(function (x) { return x.trim(); }).filter(Boolean);
          d.skills = { technical: parts, soft: [], tools: [] };
        }
        if (!d.skills || typeof d.skills !== 'object') {
          d.skills = { technical: [], soft: [], tools: [] };
        }
        if (!Array.isArray(d.skills.technical)) d.skills.technical = [];
        if (!Array.isArray(d.skills.soft)) d.skills.soft = [];
        if (!Array.isArray(d.skills.tools)) d.skills.tools = [];
        var projs = d.projects || [];
        d.projects = projs.map(function (p) {
          if (typeof p === 'object' && p !== null) {
            return {
              title: p.title || p.name || '',
              description: (p.description || '').substring(0, 200),
              techStack: Array.isArray(p.techStack) ? p.techStack : [],
              liveUrl: p.liveUrl || '',
              githubUrl: p.githubUrl || ''
            };
          }
          return { title: '', description: '', techStack: [], liveUrl: '', githubUrl: '' };
        });
        if (d.projects.length === 0) d.projects = [{ title: '', description: '', techStack: [], liveUrl: '', githubUrl: '' }];
        return d;
      }

      function getData() {
        try {
          var s = localStorage.getItem(DATA_KEY);
          var raw = s ? JSON.parse(s) : null;
          return migrateData(raw);
        } catch (e) { return defaultData(); }
      }

      function defaultData() {
        return {
          name: '', email: '', phone: '', location: '',
          summary: '',
          education: [],
          experience: [],
          projects: [{ title: '', description: '', techStack: [], liveUrl: '', githubUrl: '' }],
          skills: { technical: [], soft: [], tools: [] },
          github: '', linkedin: ''
        };
      }

      function sampleData() {
        return {
          name: 'Alex Chen',
          email: 'alex.chen@email.com',
          phone: '+1 (555) 123-4567',
          location: 'San Francisco, CA',
          summary: 'Full-stack engineer with 5+ years building scalable web applications. Passionate about clean code and user experience.',
          education: [
            { school: 'Stanford University', degree: 'B.S. Computer Science', years: '2015 – 2019' }
          ],
          experience: [
            { company: 'Tech Corp', role: 'Senior Software Engineer', dates: '2021 – Present', description: 'Lead development of customer-facing platform. Reduced load times by 40%.' },
            { company: 'Startup Inc', role: 'Software Engineer', dates: '2019 – 2021', description: 'Built REST APIs and React frontends. Mentored 2 junior engineers.' }
          ],
          projects: [
            { title: 'Open Source CLI Tool', description: 'Developer tool with 10k+ weekly downloads.', techStack: ['Node.js', 'TypeScript'], liveUrl: 'https://example.com', githubUrl: 'https://github.com/alexchen/cli-tool' }
          ],
          skills: {
            technical: ['TypeScript', 'React', 'Node.js', 'PostgreSQL', 'GraphQL'],
            soft: ['Team Leadership', 'Problem Solving'],
            tools: ['Git', 'Docker', 'AWS']
          },
          github: 'https://github.com/alexchen',
          linkedin: 'https://linkedin.com/in/alexchen'
        };
      }

      function setData(d) {
        try {
          localStorage.setItem(DATA_KEY, JSON.stringify(d));
        } catch (e) {}
      }

      function escapeHtml(s) {
        if (!s) return '';
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      function wordCount(str) {
        return (str || '').trim().split(/\s+/).filter(Boolean).length;
      }

      function hasNumbers(text) {
        if (!text || !String(text).trim()) return false;
        return /\d|%|k\b|K\b|\bx\s*\d|\d+\s*x/i.test(String(text));
      }

      function startsWithActionVerb(text) {
        var first = (text || '').trim().toLowerCase();
        for (var i = 0; i < ACTION_VERBS.length; i++) {
          if (first.indexOf(ACTION_VERBS[i]) === 0) return true;
        }
        return false;
      }

      function getBulletGuidance(lines) {
        var tips = [];
        lines.forEach(function (line, idx) {
          var t = line.trim();
          if (!t) return;
          var needsVerb = !startsWithActionVerb(t);
          var needsNum = !hasNumbers(t);
          if (needsVerb || needsNum) {
            var parts = [];
            if (needsVerb) parts.push('Start with a strong action verb.');
            if (needsNum) parts.push('Add measurable impact (numbers).');
            tips.push({ line: idx + 1, msg: parts.join(' ') });
          }
        });
        return tips;
      }

      function getSkillsCount(d) {
        var s = d.skills || { technical: [], soft: [], tools: [] };
        return (s.technical || []).length + (s.soft || []).length + (s.tools || []).length;
      }

      var ATS_ACTION_VERBS = ['built', 'led', 'designed', 'improved', 'developed', 'created', 'implemented', 'managed', 'achieved', 'reduced', 'increased', 'delivered', 'launched', 'optimized', 'automated', 'improve', 'develop', 'create', 'lead', 'design'];

      function summaryHasActionVerbs(text) {
        var t = (text || '').toLowerCase();
        for (var i = 0; i < ATS_ACTION_VERBS.length; i++) {
          if (t.indexOf(ATS_ACTION_VERBS[i]) >= 0) return true;
        }
        return false;
      }

      function hasExpWithBullets(d) {
        var exp = d.experience || [];
        for (var i = 0; i < exp.length; i++) {
          if ((exp[i].description || '').trim().split(/\r?\n/).filter(Boolean).length > 0) return true;
        }
        return false;
      }

      function hasEduEntry(d) {
        var edu = d.education || [];
        for (var i = 0; i < edu.length; i++) {
          if ((edu[i].school || '').trim() || (edu[i].degree || '').trim() || (edu[i].years || '').trim()) return true;
        }
        return false;
      }

      function computeAtsScore(d) {
        var score = 0;
        if ((d.name || '').trim()) score += 10;
        if ((d.email || '').trim()) score += 10;
        if ((d.summary || '').trim().length > 50) score += 10;
        if (hasExpWithBullets(d)) score += 15;
        if (hasEduEntry(d)) score += 10;
        if (getSkillsCount(d) >= 5) score += 10;
        var projCount = (d.projects || []).filter(function (p) { return (p.title || '').trim(); }).length;
        if (projCount >= 1) score += 10;
        if ((d.phone || '').trim()) score += 5;
        if ((d.linkedin || '').trim()) score += 5;
        if ((d.github || '').trim()) score += 5;
        if (summaryHasActionVerbs(d.summary)) score += 10;
        return Math.min(100, score);
      }

      function getTopImprovements(d) {
        var list = [];
        if (!(d.name || '').trim()) list.push('Add your name (+10 points)');
        if (!(d.email || '').trim()) list.push('Add your email (+10 points)');
        if ((d.summary || '').trim().length <= 50) list.push('Add a professional summary longer than 50 characters (+10 points)');
        if (!hasExpWithBullets(d)) list.push('Add at least 1 experience entry with bullet points (+15 points)');
        if (!hasEduEntry(d)) list.push('Add at least 1 education entry (+10 points)');
        if (getSkillsCount(d) < 5) list.push('Add at least 5 skills (+10 points)');
        var projCount = (d.projects || []).filter(function (p) { return (p.title || '').trim(); }).length;
        if (projCount < 1) list.push('Add at least 1 project (+10 points)');
        if (!(d.phone || '').trim()) list.push('Add phone number (+5 points)');
        if (!(d.linkedin || '').trim()) list.push('Add LinkedIn URL (+5 points)');
        if (!(d.github || '').trim()) list.push('Add GitHub URL (+5 points)');
        if (!summaryHasActionVerbs(d.summary) && (d.summary || '').trim()) list.push('Add action verbs to summary (built, led, designed, etc.) (+10 points)');
        return list.slice(0, 6);
      }

      function getAtsLabel(score) {
        if (score <= 40) return 'Needs Work';
        if (score <= 70) return 'Getting There';
        return 'Strong Resume';
      }

      function getAtsColor(score) {
        if (score <= 40) return '#dc2626';
        if (score <= 70) return '#d97706';
        return '#16a34a';
      }

      function getProofSubmission() {
        try {
          var s = localStorage.getItem(PROOF_SUBMISSION_KEY);
          var o = s ? JSON.parse(s) : {};
          return { lovableLink: o.lovableLink || '', githubLink: o.githubLink || '', deployedUrl: o.deployedUrl || '' };
        } catch (e) { return { lovableLink: '', githubLink: '', deployedUrl: '' }; }
      }
      function setProofSubmission(o) {
        try {
          localStorage.setItem(PROOF_SUBMISSION_KEY, JSON.stringify(o));
        } catch (e) {}
      }
      function getProofChecklist() {
        try {
          var s = localStorage.getItem(PROOF_CHECKLIST_KEY);
          if (!s) return [false, false, false, false, false, false, false, false, false, false];
          var arr = JSON.parse(s);
          while (arr.length < 10) arr.push(false);
          return arr.slice(0, 10);
        } catch (e) { return [false, false, false, false, false, false, false, false, false, false]; }
      }
      function setProofChecklist(arr) {
        try {
          localStorage.setItem(PROOF_CHECKLIST_KEY, JSON.stringify(arr.slice(0, 10)));
        } catch (e) {}
      }
      function isValidUrl(str) {
        if (!str || typeof str !== 'string') return false;
        var s = str.trim();
        if (s.length < 10) return false;
        try {
          var u = new URL(s);
          return u.protocol === 'http:' || u.protocol === 'https:';
        } catch (e) { return false; }
      }
      function getStepCompletion(d) {
        var steps = [
          { name: 'Personal Info', done: !!(d.name || '').trim() && !!(d.email || '').trim() },
          { name: 'Professional Summary', done: (d.summary || '').trim().length > 50 },
          { name: 'Education', done: hasEduEntry(d) },
          { name: 'Experience', done: hasExpWithBullets(d) },
          { name: 'Skills', done: getSkillsCount(d) >= 5 },
          { name: 'Projects', done: (d.projects || []).filter(function (p) { return (p.title || '').trim(); }).length >= 1 },
          { name: 'Template & Styling', done: true },
          { name: 'Final Review', done: !!(d.name || '').trim() && (hasExpWithBullets(d) || (d.projects || []).filter(function (p) { return (p.title || '').trim(); }).length >= 1) }
        ];
        return steps;
      }
      function allStepsComplete(d) {
        var steps = getStepCompletion(d);
        return steps.every(function (s) { return s.done; });
      }
      function allChecklistPassed() {
        var arr = getProofChecklist();
        return arr.length >= 10 && arr.every(function (x) { return x === true; });
      }
      function allProofLinksValid() {
        var p = getProofSubmission();
        return isValidUrl(p.lovableLink) && isValidUrl(p.githubLink) && isValidUrl(p.deployedUrl);
      }
      function isShipped() {
        var d = getData();
        return allStepsComplete(d) && allChecklistPassed() && allProofLinksValid();
      }
      function getFinalSubmissionText() {
        var p = getProofSubmission();
        return '------------------------------------------\n' +
          'AI Resume Builder — Final Submission\n\n' +
          'Lovable Project: ' + (p.lovableLink || '(not set)') + '\n' +
          'GitHub Repository: ' + (p.githubLink || '(not set)') + '\n' +
          'Live Deployment: ' + (p.deployedUrl || '(not set)') + '\n\n' +
          'Core Capabilities:\n' +
          '- Structured resume builder\n' +
          '- Deterministic ATS scoring\n' +
          '- Template switching\n' +
          '- PDF export with clean formatting\n' +
          '- Persistence + validation checklist\n' +
          '------------------------------------------';
      }

      function checkExportWarning(d) {
        var noName = !(d.name || '').trim();
        var noExp = (d.experience || []).length === 0;
        var noProj = (d.projects || []).filter(function (p) { return (p.title || '').trim(); }).length === 0;
        return noName || (noExp && noProj);
      }

      function getResumeAsPlainText(d) {
        var lines = [];
        lines.push((d.name || '').trim() || 'Your Name');
        lines.push('');
        var contact = [d.email, d.phone, d.location].filter(Boolean).join(' · ');
        if (contact) { lines.push('CONTACT'); lines.push(contact); lines.push(''); }
        var summary = (d.summary || '').trim();
        if (summary) { lines.push('SUMMARY'); lines.push(summary); lines.push(''); }
        var edu = (d.education || []).filter(function (e) { return (e.school || '').trim() || (e.degree || '').trim() || (e.years || '').trim(); });
        if (edu.length) {
          lines.push('EDUCATION');
          edu.forEach(function (e) {
            lines.push((e.school || '') + ' · ' + (e.degree || '') + ' · ' + (e.years || ''));
          });
          lines.push('');
        }
        var exp = (d.experience || []).filter(function (e) { return (e.company || '').trim() || (e.role || '').trim(); });
        if (exp.length) {
          lines.push('EXPERIENCE');
          exp.forEach(function (e) {
            lines.push((e.role || '') + (e.company ? ' at ' + e.company : '') + ' · ' + (e.dates || ''));
            if ((e.description || '').trim()) lines.push(e.description.trim());
          });
          lines.push('');
        }
        var proj = (d.projects || []).filter(function (p) { return (p.title || '').trim(); });
        if (proj.length) {
          lines.push('PROJECTS');
          proj.forEach(function (p) {
            lines.push(p.title || '');
            if ((p.description || '').trim()) lines.push(p.description.trim());
            if (Array.isArray(p.techStack) && p.techStack.length) lines.push('Tech: ' + p.techStack.join(', '));
            if ((p.liveUrl || '').trim()) lines.push('Live: ' + p.liveUrl);
            if ((p.githubUrl || '').trim()) lines.push('GitHub: ' + p.githubUrl);
          });
          lines.push('');
        }
        var s = d.skills || { technical: [], soft: [], tools: [] };
        var skills = [].concat(s.technical || [], s.soft || [], s.tools || []).filter(Boolean);
        if (skills.length) { lines.push('SKILLS'); lines.push(skills.join(', ')); lines.push(''); }
        var links = [];
        if ((d.github || '').trim()) links.push(d.github);
        if ((d.linkedin || '').trim()) links.push(d.linkedin);
        if (links.length) { lines.push('LINKS'); lines.push(links.join(' · ')); }
        return lines.join('\n').replace(/\n{3,}/g, '\n\n').trim();
      }

      function renderPreviewHtml(d) {
        var nameStr = (d.name || '').trim();
        var nameHtml = nameStr ? escapeHtml(nameStr) : '<span class="preview-placeholder">Your name</span>';
        var contactParts = [d.email, d.phone, d.location].filter(Boolean);
        var contactLine = contactParts.length ? escapeHtml(contactParts.join(' · ')) : '';
        var links = [];
        if ((d.github || '').trim()) links.push('<a href="' + escapeHtml(d.github) + '" target="_blank" rel="noopener" style="color:#111;">GitHub</a>');
        if ((d.linkedin || '').trim()) links.push('<a href="' + escapeHtml(d.linkedin) + '" target="_blank" rel="noopener" style="color:#111;">LinkedIn</a>');
        var linksHtml = links.length ? links.join(' · ') : '';

        var summaryStr = (d.summary || '').trim();
        var summarySection = summaryStr
          ? '<div class="preview-section"><div class="preview-section-title">Summary</div><p class="preview-item-desc">' + escapeHtml(summaryStr) + '</p></div>'
          : '';

        var eduItems = (d.education || []).filter(function (e) { return (e.school || '').trim() || (e.degree || '').trim() || (e.years || '').trim(); });
        var eduSection = eduItems.length
          ? '<div class="preview-section"><div class="preview-section-title">Education</div>' +
            eduItems.map(function (e) {
              return '<div class="preview-item"><div class="preview-item-title">' + escapeHtml(e.school || '') + '</div>' +
                '<div class="preview-item-meta">' + escapeHtml(e.degree || '') + ' · ' + escapeHtml(e.years || '') + '</div></div>';
            }).join('') + '</div>'
          : '';

        var expItems = (d.experience || []).filter(function (e) { return (e.company || '').trim() || (e.role || '').trim(); });
        var expSection = expItems.length
          ? '<div class="preview-section"><div class="preview-section-title">Experience</div>' +
            expItems.map(function (e) {
              return '<div class="preview-item"><div class="preview-item-title">' + escapeHtml(e.role || '') + (e.company ? ' at ' + escapeHtml(e.company) : '') + '</div>' +
                '<div class="preview-item-meta">' + escapeHtml(e.dates || '') + '</div>' +
                ((e.description || '').trim() ? '<p class="preview-item-desc">' + escapeHtml(e.description) + '</p>' : '') + '</div>';
            }).join('') + '</div>'
          : '';

        var projItems = (d.projects || []).filter(function (p) { return (p.title || '').trim(); });
        var projSection = projItems.length
          ? '<div class="preview-section"><div class="preview-section-title">Projects</div>' +
            projItems.map(function (p) {
              var techPills = (Array.isArray(p.techStack) ? p.techStack : []).filter(Boolean).map(function (t) {
                return '<span class="kn-preview-skill-pill">' + escapeHtml(t) + '</span>';
              }).join('');
              var links = [];
              if ((p.liveUrl || '').trim()) links.push('<a href="' + escapeHtml(p.liveUrl) + '" target="_blank" rel="noopener">↗ Live</a>');
              if ((p.githubUrl || '').trim()) links.push('<a href="' + escapeHtml(p.githubUrl) + '" target="_blank" rel="noopener">↗ GitHub</a>');
              var linksHtml = links.length ? '<div class="kn-preview-project-links">' + links.join(' ') + '</div>' : '';
              return '<div class="kn-preview-project-card"><div class="preview-item-title">' + escapeHtml(p.title || '') + '</div>' +
                ((p.description || '').trim() ? '<p class="preview-item-desc">' + escapeHtml(p.description) + '</p>' : '') +
                (techPills ? '<div class="kn-preview-skill-pills">' + techPills + '</div>' : '') +
                linksHtml + '</div>';
            }).join('') + '</div>'
          : '';

        var s = d.skills || { technical: [], soft: [], tools: [] };
        var techList = (s.technical || []).filter(Boolean);
        var softList = (s.soft || []).filter(Boolean);
        var toolsList = (s.tools || []).filter(Boolean);
        var hasSkills = techList.length || softList.length || toolsList.length;
        var skillsSection = hasSkills
          ? '<div class="preview-section"><div class="preview-section-title">Skills</div>' +
            (techList.length ? '<div class="kn-preview-skill-group"><div class="kn-preview-skill-pills">' +
              techList.map(function (x) { return '<span class="kn-preview-skill-pill">' + escapeHtml(x) + '</span>'; }).join('') + '</div></div>' : '') +
            (softList.length ? '<div class="kn-preview-skill-group"><div class="kn-preview-skill-pills">' +
              softList.map(function (x) { return '<span class="kn-preview-skill-pill">' + escapeHtml(x) + '</span>'; }).join('') + '</div></div>' : '') +
            (toolsList.length ? '<div class="kn-preview-skill-group"><div class="kn-preview-skill-pills">' +
              toolsList.map(function (x) { return '<span class="kn-preview-skill-pill">' + escapeHtml(x) + '</span>'; }).join('') + '</div></div>' : '') +
            '</div>'
          : '';

        var linksSection = linksHtml
          ? '<div class="preview-section"><div class="preview-section-title">Links</div><p class="preview-item-desc">' + linksHtml + '</p></div>'
          : '';

        var tpl = getTemplate();
        if (tpl === 'modern') {
          var sidebarContent = (contactLine ? '<div class="preview-section"><div class="preview-section-title">Contact</div><p class="preview-item-desc">' + contactLine + '</p></div>' : '') +
            (hasSkills ? skillsSection : '') +
            (linksSection || '');
          var mainContent = '<h1 class="preview-name">' + nameHtml + '</h1>' +
            summarySection + eduSection + expSection + projSection;
          return '<div class="kn-preview-minimal kn-preview-modern-wrap">' +
            '<div class="kn-preview-sidebar">' + sidebarContent + '</div>' +
            '<div class="kn-preview-main">' + mainContent + '</div></div>';
        }
        return '<div class="kn-preview-minimal">' +
          '<h1 class="preview-name">' + nameHtml + '</h1>' +
          (contactLine ? '<p class="preview-contact">' + contactLine + '</p>' : '') +
          summarySection + eduSection + expSection + projSection + skillsSection +
          (linksSection || '') +
          '</div>';
      }

      function bindForm(d) {
        var ids = ['name','email','phone','location','summary','github','linkedin'];
        ids.forEach(function (id) {
          var el = document.getElementById('rb-' + id);
          if (el) {
            el.value = d[id] || '';
            el.oninput = function () {
              d[id] = this.value;
              setData(d);
              updateLivePreview();
            };
          }
        });

        function ensureSkillsObj() {
          if (!d.skills || typeof d.skills !== 'object') d.skills = { technical: [], soft: [], tools: [] };
          if (!Array.isArray(d.skills.technical)) d.skills.technical = [];
          if (!Array.isArray(d.skills.soft)) d.skills.soft = [];
          if (!Array.isArray(d.skills.tools)) d.skills.tools = [];
        }
        function renderSkillChips(cat, wrapId, inputId, countId) {
          ensureSkillsObj();
          var wrap = document.getElementById(wrapId);
          if (!wrap) return;
          var input = document.getElementById(inputId);
          var arr = d.skills[cat] || [];
          var chips = arr.map(function (val, i) {
            return '<span class="kn-tag-chip" data-cat="' + cat + '" data-i="' + i + '">' + escapeHtml(val) + '<span class="kn-tag-chip__remove" data-remove="1">×</span></span>';
          }).join('');
          wrap.innerHTML = chips + '<input type="text" class="kn-tag-input" id="' + inputId + '" placeholder="Type and press Enter" />';
          var countEl = document.getElementById(countId);
          if (countEl) countEl.textContent = arr.length;
          wrap.querySelectorAll('.kn-tag-chip__remove').forEach(function (btn) {
            btn.onclick = function () {
              var chip = btn.closest('.kn-tag-chip');
              var i = parseInt(chip.getAttribute('data-i'), 10);
              ensureSkillsObj();
              d.skills[cat].splice(i, 1);
              setData(d);
              renderSkillChips(cat, wrapId, inputId, countId);
              updateLivePreview();
            };
          });
          var inp = document.getElementById(inputId);
          if (inp) {
            inp.onkeydown = function (e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                var v = this.value.trim();
                if (v) {
                  ensureSkillsObj();
                  if (d.skills[cat].indexOf(v) < 0) {
                    d.skills[cat].push(v);
                    setData(d);
                    renderSkillChips(cat, wrapId, inputId, countId);
                    this.value = '';
                    updateLivePreview();
                  }
                }
              }
            };
          }
        }
        renderSkillChips('technical', 'rb-skills-tech-wrap', 'rb-skills-tech-input', 'rb-skills-tech-count');
        renderSkillChips('soft', 'rb-skills-soft-wrap', 'rb-skills-soft-input', 'rb-skills-soft-count');
        renderSkillChips('tools', 'rb-skills-tools-wrap', 'rb-skills-tools-input', 'rb-skills-tools-count');

        document.querySelectorAll('#rb-skills-technical, #rb-skills-soft, #rb-skills-tools').forEach(function (acc) {
          var header = acc && acc.querySelector('.kn-accordion__header');
          if (header) {
            header.onclick = function () { acc.classList.toggle('is-closed'); };
          }
        });

        var suggestBtn = document.getElementById('rb-suggest-skills');
        if (suggestBtn) {
          suggestBtn.onclick = function () {
            var origText = suggestBtn.textContent;
            suggestBtn.textContent = 'Loading...';
            suggestBtn.disabled = true;
            setTimeout(function () {
              ensureSkillsObj();
              function addSkill(cat, items) {
                items.forEach(function (item) {
                  if (d.skills[cat].indexOf(item) < 0) d.skills[cat].push(item);
                });
              }
              addSkill('technical', ['TypeScript', 'React', 'Node.js', 'PostgreSQL', 'GraphQL']);
              addSkill('soft', ['Team Leadership', 'Problem Solving']);
              addSkill('tools', ['Git', 'Docker', 'AWS']);
              setData(d);
              renderSkillChips('technical', 'rb-skills-tech-wrap', 'rb-skills-tech-input', 'rb-skills-tech-count');
              renderSkillChips('soft', 'rb-skills-soft-wrap', 'rb-skills-soft-input', 'rb-skills-soft-count');
              renderSkillChips('tools', 'rb-skills-tools-wrap', 'rb-skills-tools-input', 'rb-skills-tools-count');
              suggestBtn.textContent = origText;
              suggestBtn.disabled = false;
              updateLivePreview();
            }, 1000);
          };
        }

        function updateLivePreview() {
          var data = getData();
          var panel = document.getElementById('rb-live-preview');
          if (panel) {
            panel.className = 'kn-preview-paper tpl-' + getTemplate();
            panel.style.setProperty('--kn-resume-accent', getAccentHsl());
            panel.innerHTML = renderPreviewHtml(data);
          }
          var score = computeAtsScore(data);
          var fillEl = document.getElementById('rb-ats-fill');
          var valueEl = document.getElementById('rb-ats-value');
          if (fillEl) { fillEl.style.width = score + '%'; fillEl.style.background = getAtsColor(score); }
          if (valueEl) valueEl.textContent = score + ' / 100';
          var improvements = getTopImprovements(data);
          var imprEl = document.getElementById('rb-improvements-list');
          if (imprEl) {
            imprEl.innerHTML = improvements.length ? improvements.map(function (s) { return '<li>' + escapeHtml(s) + '</li>'; }).join('') : '<li style="color:var(--kn-success);">No improvements needed. Strong resume!</li>';
          }
        }

        function bindTemplateThumbs() {
          document.querySelectorAll('.kn-template-thumb').forEach(function (el) {
            el.onclick = function () {
              var t = this.getAttribute('data-template');
              setTemplate(t);
              document.querySelectorAll('.kn-template-thumb').forEach(function (b) { b.classList.toggle('is-active', b.getAttribute('data-template') === t); });
              updateLivePreview();
            };
          });
          var cur = getTemplate();
          document.querySelectorAll('.kn-template-thumb').forEach(function (b) { b.classList.toggle('is-active', b.getAttribute('data-template') === cur); });
        }
        function bindColorPicker() {
          document.querySelectorAll('.kn-color-swatch').forEach(function (el) {
            el.onclick = function () {
              var c = this.getAttribute('data-color');
              setColor(c);
              document.querySelectorAll('.kn-color-swatch').forEach(function (b) { b.classList.toggle('is-active', b.getAttribute('data-color') === c); });
              var accent = getAccentHsl();
              document.querySelectorAll('.kn-template-thumb.kn-thumb-modern .kn-thumb-sidebar').forEach(function (s) { s.style.background = accent; });
              updateLivePreview();
            };
          });
          var curColor = getColor();
          document.querySelectorAll('.kn-color-swatch').forEach(function (b) { b.classList.toggle('is-active', b.getAttribute('data-color') === curColor); });
          var accent = getAccentHsl();
          document.querySelectorAll('.kn-template-thumb.kn-thumb-modern .kn-thumb-sidebar').forEach(function (s) { s.style.background = accent; });
        }

        function renderEducation() {
          var list = document.getElementById('rb-education-list');
          if (!list) return;
          list.innerHTML = (d.education || []).map(function (item, i) {
            return '<li class="kn-entry-item" data-index="' + i + '">' +
              '<div class="kn-entry-item__row"><input type="text" class="kn-input" placeholder="School" data-field="school" value="' + escapeHtml(item.school || '') + '" />' +
              '<button type="button" class="kn-btn kn-btn--secondary kn-entry-remove" data-action="remove-edu" data-index="' + i + '">Remove</button></div>' +
              '<div class="kn-entry-item__row"><input type="text" class="kn-input" placeholder="Degree" data-field="degree" value="' + escapeHtml(item.degree || '') + '" />' +
              '<input type="text" class="kn-input" placeholder="Years" data-field="years" value="' + escapeHtml(item.years || '') + '" /></div></li>';
          }).join('');
          list.querySelectorAll('input').forEach(function (inp) {
            inp.oninput = function () {
              var i = parseInt(inp.closest('.kn-entry-item').getAttribute('data-index'), 10);
              var field = inp.getAttribute('data-field');
              if (!d.education[i]) d.education[i] = {};
              d.education[i][field] = inp.value;
              setData(d);
              updateLivePreview();
            };
          });
          list.querySelectorAll('[data-action="remove-edu"]').forEach(function (btn) {
            btn.onclick = function () {
              var i = parseInt(btn.getAttribute('data-index'), 10);
              d.education.splice(i, 1);
              setData(d);
              renderEducation();
              updateLivePreview();
            };
          });
        }

        function updateBulletGuidance(descEl, type, index) {
          var guidanceEl = descEl.nextElementSibling;
          if (!guidanceEl || !guidanceEl.classList.contains('kn-bullet-guidance')) return;
          var lines = (descEl.value || '').split(/\r?\n/).filter(Boolean);
          var tips = getBulletGuidance(lines);
          guidanceEl.innerHTML = tips.length ? tips.map(function (t) {
            return '<div class="kn-bullet-guidance__item"><span class="kn-bullet-guidance__tip">Line ' + t.line + ': ' + escapeHtml(t.msg) + '</span></div>';
          }).join('') : '';
          guidanceEl.style.display = tips.length ? 'block' : 'none';
        }

        function renderExperience() {
          var list = document.getElementById('rb-experience-list');
          if (!list) return;
          list.innerHTML = (d.experience || []).map(function (item, i) {
            return '<li class="kn-entry-item" data-index="' + i + '">' +
              '<div class="kn-entry-item__row"><input type="text" class="kn-input" placeholder="Company" data-field="company" value="' + escapeHtml(item.company || '') + '" />' +
              '<button type="button" class="kn-btn kn-btn--secondary kn-entry-remove" data-action="remove-exp" data-index="' + i + '">Remove</button></div>' +
              '<div class="kn-entry-item__row"><input type="text" class="kn-input" placeholder="Role" data-field="role" value="' + escapeHtml(item.role || '') + '" />' +
              '<input type="text" class="kn-input" placeholder="Dates" data-field="dates" value="' + escapeHtml(item.dates || '') + '" /></div>' +
              '<textarea class="kn-input kn-textarea" placeholder="Description (one bullet per line)" data-field="description" rows="3">' + escapeHtml(item.description || '') + '</textarea>' +
              '<div class="kn-bullet-guidance" style="display:none;"></div></li>';
          }).join('');
          list.querySelectorAll('input, textarea').forEach(function (inp) {
            inp.oninput = inp.onchange = function () {
              var i = parseInt(inp.closest('.kn-entry-item').getAttribute('data-index'), 10);
              var field = inp.getAttribute('data-field');
              if (!d.experience[i]) d.experience[i] = {};
              d.experience[i][field] = inp.value;
              setData(d);
              updateLivePreview();
              if (field === 'description') updateBulletGuidance(inp, 'exp', i);
            };
          });
          list.querySelectorAll('textarea[data-field="description"]').forEach(function (ta) {
            var i = parseInt(ta.closest('.kn-entry-item').getAttribute('data-index'), 10);
            updateBulletGuidance(ta, 'exp', i);
          });
          list.querySelectorAll('[data-action="remove-exp"]').forEach(function (btn) {
            btn.onclick = function () {
              var i = parseInt(btn.getAttribute('data-index'), 10);
              d.experience.splice(i, 1);
              setData(d);
              renderExperience();
              updateLivePreview();
            };
          });
        }

        function renderProjectTechChips(wrap, proj) {
          var tech = proj.techStack || [];
          var chips = tech.map(function (val, j) {
            return '<span class="kn-tag-chip" data-j="' + j + '">' + escapeHtml(val) + '<span class="kn-tag-chip__remove">×</span></span>';
          }).join('');
          wrap.innerHTML = chips + '<input type="text" class="kn-tag-input kn-proj-tech-input" placeholder="Tech stack, press Enter" />';
          wrap.querySelectorAll('.kn-tag-chip__remove').forEach(function (btn) {
            btn.onclick = function () {
              var chip = btn.closest('.kn-tag-chip');
              var j = parseInt(chip.getAttribute('data-j'), 10);
              proj.techStack.splice(j, 1);
              setData(d);
              renderProjectTechChips(wrap, proj);
              updateLivePreview();
            };
          });
          var inp = wrap.querySelector('.kn-proj-tech-input');
          if (inp) {
            inp.onkeydown = function (e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                var v = this.value.trim();
                if (v && (proj.techStack || []).indexOf(v) < 0) {
                  proj.techStack = proj.techStack || [];
                  proj.techStack.push(v);
                  setData(d);
                  renderProjectTechChips(wrap, proj);
                  this.value = '';
                  updateLivePreview();
                }
              }
            };
          }
        }

        function renderProjects() {
          var list = document.getElementById('rb-projects-list');
          if (!list) return;
          var projs = d.projects || [];
          list.innerHTML = projs.map(function (item, i) {
            var title = (item.title || '').trim() || 'New Project';
            var desc = (item.description || '').substring(0, 200);
            var descLen = desc.length;
            var techChips = (item.techStack || []).map(function (t) { return '<span class="kn-tag-chip"><span>' + escapeHtml(t) + '</span></span>'; }).join('');
            return '<li class="kn-entry-item kn-accordion" data-index="' + i + '">' +
              '<div class="kn-accordion__header" style="display:flex;align-items:center;justify-content:space-between;">' +
              '<span class="kn-project-header-title">' + escapeHtml(title) + '</span>' +
              '<button type="button" class="kn-btn kn-btn--secondary kn-entry-remove" data-action="remove-proj" data-index="' + i + '">Delete</button></div>' +
              '<div class="kn-accordion__body">' +
              '<div class="kn-field" style="margin-bottom: var(--kn-space-2);"><label class="kn-label">Project Title</label>' +
              '<input type="text" class="kn-input rb-proj-title" placeholder="Project name" value="' + escapeHtml(item.title || '') + '" /></div>' +
              '<div class="kn-field" style="margin-bottom: var(--kn-space-2);"><label class="kn-label">Description</label>' +
              '<textarea class="kn-input kn-textarea rb-proj-desc" placeholder="Brief description (max 200 chars)" rows="3" maxlength="200">' + escapeHtml(desc) + '</textarea>' +
              '<div class="kn-desc-counter' + (descLen >= 200 ? ' is-over' : '') + '" data-counter="' + i + '">' + descLen + ' / 200</div></div>' +
              '<div class="kn-field" style="margin-bottom: var(--kn-space-2);"><label class="kn-label">Tech Stack</label>' +
              '<div class="kn-tag-input-wrap rb-proj-tech-wrap" data-index="' + i + '"></div></div>' +
              '<div class="kn-field" style="margin-bottom: var(--kn-space-2);"><label class="kn-label">Live URL (optional)</label>' +
              '<input type="url" class="kn-input rb-proj-live" placeholder="https://..." value="' + escapeHtml(item.liveUrl || '') + '" /></div>' +
              '<div class="kn-field"><label class="kn-label">GitHub URL (optional)</label>' +
              '<input type="url" class="kn-input rb-proj-github" placeholder="https://github.com/..." value="' + escapeHtml(item.githubUrl || '') + '" /></div></div></li>';
          }).join('');

          list.querySelectorAll('.kn-accordion__header').forEach(function (h) {
            var acc = h.closest('.kn-accordion');
            if (acc) h.onclick = function (e) { if (!e.target.closest('button')) acc.classList.toggle('is-closed'); };
          });
          list.querySelectorAll('.rb-proj-title').forEach(function (inp) {
            var i = parseInt(inp.closest('[data-index]').getAttribute('data-index'), 10);
            inp.oninput = function () {
              if (!d.projects[i]) d.projects[i] = {};
              d.projects[i].title = this.value;
              var titleEl = inp.closest('.kn-entry-item').querySelector('.kn-project-header-title');
              if (titleEl) titleEl.textContent = (this.value || '').trim() || 'New Project';
              setData(d);
              updateLivePreview();
            };
          });
          list.querySelectorAll('.rb-proj-desc').forEach(function (ta) {
            var i = parseInt(ta.closest('[data-index]').getAttribute('data-index'), 10);
            var counterEl = ta.nextElementSibling;
            ta.oninput = function () {
              var val = this.value.substring(0, 200);
              this.value = val;
              if (!d.projects[i]) d.projects[i] = {};
              d.projects[i].description = val;
              if (counterEl) {
                counterEl.textContent = val.length + ' / 200';
                counterEl.classList.toggle('is-over', val.length >= 200);
              }
              setData(d);
              updateLivePreview();
            };
          });
          list.querySelectorAll('.rb-proj-live, .rb-proj-github').forEach(function (inp) {
            var i = parseInt(inp.closest('[data-index]').getAttribute('data-index'), 10);
            var field = inp.classList.contains('rb-proj-live') ? 'liveUrl' : 'githubUrl';
            inp.oninput = function () {
              if (!d.projects[i]) d.projects[i] = {};
              d.projects[i][field] = this.value;
              setData(d);
              updateLivePreview();
            };
          });
          list.querySelectorAll('.rb-proj-tech-wrap').forEach(function (wrap) {
            var i = parseInt(wrap.getAttribute('data-index'), 10);
            var proj = d.projects[i] || {};
            proj.techStack = proj.techStack || [];
            renderProjectTechChips(wrap, proj);
          });
          list.querySelectorAll('[data-action="remove-proj"]').forEach(function (btn) {
            btn.onclick = function () {
              var i = parseInt(btn.getAttribute('data-index'), 10);
              d.projects.splice(i, 1);
              if (d.projects.length === 0) d.projects.push({ title: '', description: '', techStack: [], liveUrl: '', githubUrl: '' });
              setData(d);
              renderProjects();
              updateLivePreview();
            };
          });
          list.querySelectorAll('.kn-accordion').forEach(function (acc) { acc.classList.remove('is-closed'); });
        }

        var addEdu = document.getElementById('rb-add-education');
        var addExp = document.getElementById('rb-add-experience');
        var addProj = document.getElementById('rb-add-projects');
        if (addEdu) addEdu.onclick = function () { d.education = d.education || []; d.education.push({}); setData(d); renderEducation(); updateLivePreview(); };
        if (addExp) addExp.onclick = function () { d.experience = d.experience || []; d.experience.push({}); setData(d); renderExperience(); updateLivePreview(); };
        if (addProj) addProj.onclick = function () { d.projects = d.projects || []; d.projects.push({ title: '', description: '', techStack: [], liveUrl: '', githubUrl: '' }); setData(d); renderProjects(); updateLivePreview(); };

        var loadSample = document.getElementById('rb-load-sample');
        if (loadSample) {
          loadSample.onclick = function () {
            var sample = sampleData();
            Object.keys(sample).forEach(function (k) { d[k] = sample[k]; });
            setData(d);
            render();
          };
        }

        renderEducation();
        renderExperience();
        renderProjects();
        bindTemplateThumbs();
        bindColorPicker();
        updateLivePreview();
      }

      function content(route) {
        if (route === '') {
          return '<div class="kn-landing">' +
            '<h1 class="kn-landing__headline">Build a Resume That Gets Read.</h1>' +
            '<p class="kn-landing__sub">Create a clean, ATS-friendly resume with premium typography. No clutter.</p>' +
            '<a href="#/builder" class="kn-btn kn-btn--primary" style="padding: var(--kn-space-2) var(--kn-space-4); font-size: var(--kn-text-size);">Start Building</a>' +
            '</div>';
        }

        if (route === 'builder') {
          return '<div class="kn-builder-row">' +
            '<div class="kn-builder-form">' +
            '<button type="button" class="kn-btn kn-btn--secondary" id="rb-load-sample" style="margin-bottom: var(--kn-space-4);">Load Sample Data</button>' +
            '<div class="kn-form-section"><h2 class="kn-form-section__title">Personal Info</h2>' +
            '<div class="kn-field"><label class="kn-label" for="rb-name">Name</label><input type="text" id="rb-name" class="kn-input" placeholder="Full name" /></div>' +
            '<div class="kn-field"><label class="kn-label" for="rb-email">Email</label><input type="email" id="rb-email" class="kn-input" placeholder="email@example.com" /></div>' +
            '<div class="kn-field"><label class="kn-label" for="rb-phone">Phone</label><input type="tel" id="rb-phone" class="kn-input" placeholder="+1 (555) 000-0000" /></div>' +
            '<div class="kn-field"><label class="kn-label" for="rb-location">Location</label><input type="text" id="rb-location" class="kn-input" placeholder="City, State" /></div></div>' +
            '<div class="kn-form-section"><h2 class="kn-form-section__title">Summary</h2>' +
            '<div class="kn-field"><label class="kn-label" for="rb-summary">Professional summary</label><textarea id="rb-summary" class="kn-input kn-textarea" placeholder="2–3 sentences about your background and goals"></textarea></div></div>' +
            '<div class="kn-form-section"><h2 class="kn-form-section__title">Education</h2><ul class="kn-entry-list" id="rb-education-list"></ul>' +
            '<button type="button" class="kn-btn kn-btn--secondary kn-add-entry" id="rb-add-education">Add Education</button></div>' +
            '<div class="kn-form-section"><h2 class="kn-form-section__title">Experience</h2><ul class="kn-entry-list" id="rb-experience-list"></ul>' +
            '<button type="button" class="kn-btn kn-btn--secondary kn-add-entry" id="rb-add-experience">Add Experience</button></div>' +
            '<div class="kn-form-section"><h2 class="kn-form-section__title">Skills</h2>' +
            '<button type="button" class="kn-btn kn-btn--secondary" id="rb-suggest-skills" style="margin-bottom: var(--kn-space-2);">✨ Suggest Skills</button>' +
            '<div class="kn-accordion" id="rb-skills-technical"><div class="kn-accordion__header">Technical Skills (<span id="rb-skills-tech-count">0</span>)</div><div class="kn-accordion__body"><div class="kn-tag-input-wrap" id="rb-skills-tech-wrap"><input type="text" class="kn-tag-input" id="rb-skills-tech-input" placeholder="Type and press Enter" /></div></div></div>' +
            '<div class="kn-accordion" id="rb-skills-soft"><div class="kn-accordion__header">Soft Skills (<span id="rb-skills-soft-count">0</span>)</div><div class="kn-accordion__body"><div class="kn-tag-input-wrap" id="rb-skills-soft-wrap"><input type="text" class="kn-tag-input" id="rb-skills-soft-input" placeholder="Type and press Enter" /></div></div></div>' +
            '<div class="kn-accordion" id="rb-skills-tools"><div class="kn-accordion__header">Tools & Technologies (<span id="rb-skills-tools-count">0</span>)</div><div class="kn-accordion__body"><div class="kn-tag-input-wrap" id="rb-skills-tools-wrap"><input type="text" class="kn-tag-input" id="rb-skills-tools-input" placeholder="Type and press Enter" /></div></div></div></div>' +
            '<div class="kn-form-section"><h2 class="kn-form-section__title">Projects</h2><ul class="kn-entry-list" id="rb-projects-list"></ul>' +
            '<button type="button" class="kn-btn kn-btn--secondary kn-add-entry" id="rb-add-projects">Add Project</button></div>' +
            '<div class="kn-form-section"><h2 class="kn-form-section__title">Links</h2>' +
            '<div class="kn-field"><label class="kn-label" for="rb-github">GitHub</label><input type="url" id="rb-github" class="kn-input" placeholder="https://github.com/username" /></div>' +
            '<div class="kn-field"><label class="kn-label" for="rb-linkedin">LinkedIn</label><input type="url" id="rb-linkedin" class="kn-input" placeholder="https://linkedin.com/in/username" /></div></div>' +
            '</div>' +
            '<aside class="kn-builder-panel">' +
            '<div class="kn-card" style="margin-bottom: var(--kn-space-3);">' +
            '<div class="kn-ats-score"><div class="kn-ats-score__label">ATS Readiness Score</div>' +
            '<div class="kn-ats-score__meter"><div class="kn-ats-score__fill" id="rb-ats-fill" style="width: 0%;"></div></div>' +
            '<div class="kn-ats-score__value" id="rb-ats-value">0 / 100</div></div>' +
            '<div class="kn-improvements" id="rb-improvements"><div class="kn-improvements__title">Improvement Suggestions</div>' +
            '<ul id="rb-improvements-list"></ul></div></div>' +
            '<div class="kn-card">' +
            '<div class="kn-template-picker">' +
            '<div class="kn-template-thumb kn-thumb-classic" id="rb-tpl-classic" data-template="classic" title="Classic"><div class="kn-thumb-block" style="height:14px;background:rgba(17,17,17,0.2);"></div><div class="kn-thumb-line"></div><div class="kn-thumb-block"></div><div class="kn-thumb-line"></div><div class="kn-thumb-block"></div><div class="kn-thumb-line"></div></div>' +
            '<div class="kn-template-thumb kn-thumb-modern" id="rb-tpl-modern" data-template="modern" title="Modern"><div class="kn-thumb-sidebar"></div><div class="kn-thumb-main"><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div></div></div>' +
            '<div class="kn-template-thumb kn-thumb-minimal" id="rb-tpl-minimal" data-template="minimal" title="Minimal"><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div></div></div>' +
            '<div class="kn-color-picker"><span class="kn-color-picker__label">Color:</span>' +
            '<div class="kn-color-swatch" id="rb-color-teal" data-color="teal" style="background:hsl(168,60%,40%);"></div>' +
            '<div class="kn-color-swatch" id="rb-color-navy" data-color="navy" style="background:hsl(220,60%,35%);"></div>' +
            '<div class="kn-color-swatch" id="rb-color-burgundy" data-color="burgundy" style="background:hsl(345,60%,35%);"></div>' +
            '<div class="kn-color-swatch" id="rb-color-forest" data-color="forest" style="background:hsl(150,50%,30%);"></div>' +
            '<div class="kn-color-swatch" id="rb-color-charcoal" data-color="charcoal" style="background:hsl(0,0%,25%);"></div></div>' +
            '<h2 class="kn-heading" style="margin-bottom: var(--kn-space-2);">Live Preview</h2>' +
            '<div id="rb-live-preview" class="kn-preview-paper"></div></div></aside></div>';
        }

        if (route === 'preview') {
          var d = getData();
          var tpl = getTemplate();
          var warn = checkExportWarning(d);
          var accent = getAccentHsl();
          var atsScore = computeAtsScore(d);
          var atsColor = getAtsColor(atsScore);
          var atsLabel = getAtsLabel(atsScore);
          var circ = 2 * Math.PI * 52;
          var offset = circ * (1 - atsScore / 100);
          var atsCircularHtml = '<div class="kn-ats-circular" id="rb-preview-ats">' +
            '<svg width="120" height="120" viewBox="0 0 120 120"><circle class="kn-ats-circular__bg" cx="60" cy="60" r="52"/>' +
            '<circle class="kn-ats-circular__fill" cx="60" cy="60" r="52" stroke="' + atsColor + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + offset + '"/></svg>' +
            '<div class="kn-ats-circular__value">' + atsScore + '</div></div>' +
            '<div class="kn-ats-circular__label" style="color:' + atsColor + ';">' + escapeHtml(atsLabel) + '</div>' +
            '<div class="kn-improvements" style="margin-top: var(--kn-space-2);"><div class="kn-improvements__title">Improvement Suggestions</div>' +
            '<ul id="rb-preview-improvements">' + (getTopImprovements(d).length ? getTopImprovements(d).map(function (s) { return '<li>' + escapeHtml(s) + '</li>'; }).join('') : '<li style="color:var(--kn-success);">No improvements needed. Strong resume!</li>') + '</ul></div>';
          return '<div class="kn-workspace" style="width: 100%; max-width: 720px;">' +
            '<div class="kn-card">' +
            '<h1 class="kn-heading-xl">Preview</h1>' +
            '<p class="kn-context-header__sub" style="margin-bottom: var(--kn-space-3);">Clean resume layout. Minimal black + white.</p>' +
            '<div class="kn-ats-preview-block" style="margin-bottom: var(--kn-space-3); padding: var(--kn-space-3); background: rgba(17,17,17,0.03); border-radius: var(--kn-radius);">' +
            '<div class="kn-ats-score__label" style="margin-bottom: var(--kn-space-1);">ATS Resume Score</div>' + atsCircularHtml + '</div>' +
            (warn ? '<div class="kn-export-warning" id="rb-export-warning">Your resume may look incomplete.</div>' : '') +
            '<div class="kn-export-actions">' +
            '<button type="button" class="kn-btn kn-btn--primary" id="rb-print-pdf">Print / Save as PDF</button>' +
            '<button type="button" class="kn-btn kn-btn--secondary" id="rb-copy-text">Copy Resume as Text</button>' +
            '</div>' +
            '<div class="kn-template-picker" style="margin-bottom: var(--kn-space-2);">' +
            '<div class="kn-template-thumb kn-thumb-classic rb-preview-tpl' + (tpl === 'classic' ? ' is-active' : '') + '" data-template="classic" title="Classic"><div class="kn-thumb-block" style="height:14px;background:rgba(17,17,17,0.2);"></div><div class="kn-thumb-line"></div><div class="kn-thumb-block"></div><div class="kn-thumb-line"></div><div class="kn-thumb-block"></div><div class="kn-thumb-line"></div></div>' +
            '<div class="kn-template-thumb kn-thumb-modern rb-preview-tpl' + (tpl === 'modern' ? ' is-active' : '') + '" data-template="modern" title="Modern"><div class="kn-thumb-sidebar" style="background:' + accent + ';"></div><div class="kn-thumb-main"><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div></div></div>' +
            '<div class="kn-template-thumb kn-thumb-minimal rb-preview-tpl' + (tpl === 'minimal' ? ' is-active' : '') + '" data-template="minimal" title="Minimal"><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div><div class="kn-thumb-block"></div></div></div>' +
            '<div class="kn-color-picker" style="margin-bottom: var(--kn-space-3);"><span class="kn-color-picker__label">Color:</span>' +
            '<div class="kn-color-swatch rb-preview-color' + (getColor() === 'teal' ? ' is-active' : '') + '" data-color="teal" style="background:hsl(168,60%,40%);"></div>' +
            '<div class="kn-color-swatch rb-preview-color' + (getColor() === 'navy' ? ' is-active' : '') + '" data-color="navy" style="background:hsl(220,60%,35%);"></div>' +
            '<div class="kn-color-swatch rb-preview-color' + (getColor() === 'burgundy' ? ' is-active' : '') + '" data-color="burgundy" style="background:hsl(345,60%,35%);"></div>' +
            '<div class="kn-color-swatch rb-preview-color' + (getColor() === 'forest' ? ' is-active' : '') + '" data-color="forest" style="background:hsl(150,50%,30%);"></div>' +
            '<div class="kn-color-swatch rb-preview-color' + (getColor() === 'charcoal' ? ' is-active' : '') + '" data-color="charcoal" style="background:hsl(0,0%,25%);"></div></div>' +
            '<div id="rb-preview-content" class="kn-preview-paper kn-print-resume tpl-' + tpl + '" style="--kn-resume-accent:' + accent + ';">' + renderPreviewHtml(d) + '</div></div></div>';
        }

        if (route === 'proof') {
          var d = getData();
          var steps = getStepCompletion(d);
          var shipped = isShipped();
          var sub = getProofSubmission();
          var checklist = getProofChecklist();
          var stepListHtml = steps.map(function (s, i) {
            return '<div class="kn-proof-step"><span>Step ' + (i + 1) + ': ' + escapeHtml(s.name) + '</span><span class="kn-proof-step__status ' + (s.done ? 'done' : 'pending') + '">' + (s.done ? '✓ Completed' : '— Pending') + '</span></div>';
          }).join('');
          var statusBadge = shipped ? '<span class="kn-proof-status-badge shipped">Shipped</span>' : '<span class="kn-proof-status-badge in-progress">In Progress</span>';
          var shippedMsg = shipped ? '<div class="kn-proof-shipped-msg" id="rb-proof-shipped-msg">Project 3 Shipped Successfully.</div>' : '';
          var checklistItems = [
            'All form sections save to localStorage',
            'Live preview updates in real-time',
            'Template switching preserves data',
            'Color theme persists after refresh',
            'ATS score calculates correctly',
            'Score updates live on edit',
            'Export buttons work (copy / Print PDF)',
            'Empty states handled gracefully',
            'Mobile responsive layout works',
            'No console errors on any page'
          ];
          var checklistHtml = checklistItems.map(function (text, i) {
            return '<li style="margin-bottom: var(--kn-space-2);"><label style="display: flex; align-items: center; gap: var(--kn-space-2); cursor: pointer;"><input type="checkbox" class="rb-proof-checklist-item" data-idx="' + i + '" ' + (checklist[i] ? 'checked' : '') + ' /> ' + escapeHtml(text) + '</label></li>';
          }).join('');
          return '<div class="kn-workspace" style="width: 100%; max-width: 560px;">' +
            '<h1 class="kn-heading-xl">Proof</h1>' +
            '<p class="kn-context-header__sub" style="margin-bottom: var(--kn-space-3);">Final verification and submission.</p>' +
            '<div id="rb-proof-status-wrap" style="display: flex; align-items: center; gap: var(--kn-space-2); margin-bottom: var(--kn-space-4);">Status: ' + statusBadge + '</div>' +
            (shipped ? '<div class="kn-proof-shipped-msg" id="rb-proof-shipped-msg">Project 3 Shipped Successfully.</div>' : '') +
            '<div class="kn-card" style="margin-bottom: var(--kn-space-4);">' +
            '<h2 class="kn-heading" style="margin-bottom: var(--kn-space-2);">Step Completion Overview</h2>' +
            '<p style="font-size: var(--kn-text-size-sm); color: var(--kn-text-muted); margin-bottom: var(--kn-space-2);">All 8 steps must be completed to mark Shipped.</p>' +
            '<div>' + stepListHtml + '</div></div>' +
            '<div class="kn-card" style="margin-bottom: var(--kn-space-4);">' +
            '<h2 class="kn-heading" style="margin-bottom: var(--kn-space-2);">Artifact Collection</h2>' +
            '<p style="font-size: var(--kn-text-size-sm); color: var(--kn-text-muted); margin-bottom: var(--kn-space-3);">Required to mark Shipped. All links must be valid URLs.</p>' +
            '<div class="kn-field" style="margin-bottom: var(--kn-space-2);"><label class="kn-label">Lovable Project Link</label><input type="url" id="rb-proof-lovable" class="kn-input" placeholder="https://..." value="' + escapeHtml(sub.lovableLink || '') + '" /><div class="kn-proof-input-error" id="rb-proof-lovable-err"></div></div>' +
            '<div class="kn-field" style="margin-bottom: var(--kn-space-2);"><label class="kn-label">GitHub Repository Link</label><input type="url" id="rb-proof-github" class="kn-input" placeholder="https://github.com/..." value="' + escapeHtml(sub.githubLink || '') + '" /><div class="kn-proof-input-error" id="rb-proof-github-err"></div></div>' +
            '<div class="kn-field" style="margin-bottom: var(--kn-space-2);"><label class="kn-label">Deployed URL</label><input type="url" id="rb-proof-deployed" class="kn-input" placeholder="https://..." value="' + escapeHtml(sub.deployedUrl || '') + '" /><div class="kn-proof-input-error" id="rb-proof-deployed-err"></div></div></div>' +
            '<div class="kn-card" style="margin-bottom: var(--kn-space-4);">' +
            '<h2 class="kn-heading" style="margin-bottom: var(--kn-space-2);">Feature Test Checklist</h2>' +
            '<p style="font-size: var(--kn-text-size-sm); color: var(--kn-text-muted); margin-bottom: var(--kn-space-3);">All 10 tests must be passed to mark Shipped.</p>' +
            '<ul style="list-style: none; margin: 0; padding: 0;">' + checklistHtml + '</ul></div>' +
            '<div class="kn-card">' +
            '<h2 class="kn-heading" style="margin-bottom: var(--kn-space-2);">Final Submission Export</h2>' +
            '<button type="button" class="kn-btn kn-btn--primary" id="rb-copy-final-submission">Copy Final Submission</button></div></div>';
        }

        return '<div class="kn-landing"><h1 class="kn-landing__headline">Build a Resume That Gets Read.</h1><p class="kn-landing__sub">Create a clean, ATS-friendly resume.</p><a href="#/builder" class="kn-btn kn-btn--primary">Start Building</a></div>';
      }

      function render() {
        var route = getRoute();
        var main = document.getElementById('resume-main');
        if (!main) return;

        main.classList.toggle('kn-main--home', route === '');
        main.style.flexDirection = route === '' ? 'column' : 'row';
        main.style.alignItems = route === '' ? 'center' : 'flex-start';
        main.style.justifyContent = route === '' ? 'center' : 'flex-start';
        main.innerHTML = content(route);

        document.querySelectorAll('.kn-resume-nav__link[data-route]').forEach(function (a) {
          a.classList.toggle('is-active', a.getAttribute('data-route') === route);
        });

        if (route === 'builder') bindForm(getData());
        if (route === 'preview') {
          bindPreviewTemplateThumbs();
          bindPreviewColorPicker();
          bindPreviewExport();
        }
        if (route === 'proof') bindProof();
      }

      function showToast(msg) {
        var existing = document.querySelector('.kn-toast');
        if (existing) existing.remove();
        var toast = document.createElement('div');
        toast.className = 'kn-toast';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(function () { toast.remove(); }, 3000);
      }

      function bindPreviewExport() {
        var printBtn = document.getElementById('rb-print-pdf');
        var copyBtn = document.getElementById('rb-copy-text');
        if (printBtn) printBtn.onclick = function () { window.print(); showToast('PDF export ready! Check your downloads.'); };
        if (copyBtn) copyBtn.onclick = function () {
          var d = getData();
          var text = getResumeAsPlainText(d);
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function () {
              copyBtn.textContent = 'Copied';
              setTimeout(function () { copyBtn.textContent = 'Copy Resume as Text'; }, 2000);
            }).catch(function () {
              fallbackCopy(text, copyBtn);
            });
          } else {
            fallbackCopy(text, copyBtn);
          }
        };
      }

      function fallbackCopy(text, btn, revertText) {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          if (btn) { btn.textContent = 'Copied'; setTimeout(function () { btn.textContent = revertText || 'Copy Resume as Text'; }, 2000); }
        } catch (e) {}
        document.body.removeChild(ta);
      }

      function bindPreviewTemplateThumbs() {
        document.querySelectorAll('.rb-preview-tpl').forEach(function (el) {
          el.onclick = function () {
            var t = this.getAttribute('data-template');
            setTemplate(t);
            document.querySelectorAll('.rb-preview-tpl').forEach(function (b) { b.classList.toggle('is-active', b.getAttribute('data-template') === t); });
            var previewEl = document.getElementById('rb-preview-content');
            if (previewEl) {
              previewEl.className = 'kn-preview-paper kn-print-resume tpl-' + t;
              previewEl.style.setProperty('--kn-resume-accent', getAccentHsl());
              previewEl.innerHTML = renderPreviewHtml(getData());
            }
          };
        });
      }
      function bindPreviewColorPicker() {
        document.querySelectorAll('.rb-preview-color').forEach(function (el) {
          el.onclick = function () {
            var c = this.getAttribute('data-color');
            setColor(c);
            document.querySelectorAll('.rb-preview-color').forEach(function (b) { b.classList.toggle('is-active', b.getAttribute('data-color') === c); });
            var accent = getAccentHsl();
            document.querySelectorAll('.kn-thumb-modern .kn-thumb-sidebar').forEach(function (s) { s.style.background = accent; });
            var previewEl = document.getElementById('rb-preview-content');
            if (previewEl) {
              previewEl.style.setProperty('--kn-resume-accent', accent);
              previewEl.innerHTML = renderPreviewHtml(getData());
            }
          };
        });
      }

      function updateProofStatus() {
        var shipped = isShipped();
        var statusWrap = document.getElementById('rb-proof-status-wrap');
        if (statusWrap) {
          var badge = statusWrap.querySelector('.kn-proof-status-badge');
          if (badge) {
            badge.className = 'kn-proof-status-badge ' + (shipped ? 'shipped' : 'in-progress');
            badge.textContent = shipped ? 'Shipped' : 'In Progress';
          }
        }
        var shippedMsg = document.getElementById('rb-proof-shipped-msg');
        if (shipped && !shippedMsg && statusWrap) {
          var msg = document.createElement('div');
          msg.className = 'kn-proof-shipped-msg';
          msg.id = 'rb-proof-shipped-msg';
          msg.textContent = 'Project 3 Shipped Successfully.';
          statusWrap.parentNode.insertBefore(msg, statusWrap.nextSibling);
        } else if (!shipped && shippedMsg) {
          shippedMsg.remove();
        }
      }

      function bindProof() {
        var lovableInp = document.getElementById('rb-proof-lovable');
        var githubInp = document.getElementById('rb-proof-github');
        var deployedInp = document.getElementById('rb-proof-deployed');
        var lovableErr = document.getElementById('rb-proof-lovable-err');
        var githubErr = document.getElementById('rb-proof-github-err');
        var deployedErr = document.getElementById('rb-proof-deployed-err');

        function saveAndValidateProof() {
          var p = getProofSubmission();
          p.lovableLink = (lovableInp && lovableInp.value || '').trim();
          p.githubLink = (githubInp && githubInp.value || '').trim();
          p.deployedUrl = (deployedInp && deployedInp.value || '').trim();
          setProofSubmission(p);
          if (lovableErr) lovableErr.textContent = p.lovableLink && !isValidUrl(p.lovableLink) ? 'Enter a valid URL (e.g. https://...)' : '';
          if (githubErr) githubErr.textContent = p.githubLink && !isValidUrl(p.githubLink) ? 'Enter a valid URL (e.g. https://...)' : '';
          if (deployedErr) deployedErr.textContent = p.deployedUrl && !isValidUrl(p.deployedUrl) ? 'Enter a valid URL (e.g. https://...)' : '';
          updateProofStatus();
        }

        if (lovableInp) lovableInp.oninput = lovableInp.onblur = saveAndValidateProof;
        if (githubInp) githubInp.oninput = githubInp.onblur = saveAndValidateProof;
        if (deployedInp) deployedInp.oninput = deployedInp.onblur = saveAndValidateProof;

        document.querySelectorAll('.rb-proof-checklist-item').forEach(function (cb) {
          cb.onchange = function () {
            var idx = parseInt(this.getAttribute('data-idx'), 10);
            var arr = getProofChecklist();
            arr[idx] = this.checked;
            setProofChecklist(arr);
            updateProofStatus();
          };
        });

        var copyBtn = document.getElementById('rb-copy-final-submission');
        if (copyBtn) {
          copyBtn.onclick = function () {
            var text = getFinalSubmissionText();
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).then(function () {
                showToast('Final submission copied to clipboard.');
                copyBtn.textContent = 'Copied';
                setTimeout(function () { copyBtn.textContent = 'Copy Final Submission'; }, 2000);
              }).catch(function () {
                fallbackCopy(text, copyBtn, 'Copy Final Submission');
              });
            } else {
              fallbackCopy(text, copyBtn, 'Copy Final Submission');
            }
          };
        }
      }

      window.addEventListener('hashchange', render);
      window.addEventListener('load', function () {
        var r = getRoute();
        if (r === '' && !window.location.hash) window.location.hash = '#/';
        render();
      });
    })();
  </script>
</body>
</html>
